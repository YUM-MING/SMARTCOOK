{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartCook - 실시간 YOLO</title>
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
  <script src="{% static 'js/upload.js' %}" defer></script>
</head>

<body>
  <main>
    <!-- 상단 네비 -->
    <div class="navbar">
      <div class="nav-left"><a href="{% url 'mainpage' %}" class="logo">SMARTCOOK</a></div>
      <form method="POST" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="logout-button">Logout</button>
      </form>
    </div>

    <!-- 탐색 방식 버튼 -->
    <div class="btn-group">
      <a href="{% url 'food_upload' %}" class="btn">음식으로 탐색하기</a>
      <a href="{% url 'upload' %}" class="btn">재료로 탐색하기</a>
      <button class="btn active-btn">실시간으로 탐색하기</button>
    </div>
    
    <div class="upload-container">
  <div class="upload-form-box" style="position: relative; width: 100%; max-width: 480px; margin: 0 auto;">
    <h2 class="upload-title" style="text-align: center;">실시간 YOLO</h2>
    <div style="position: relative; padding-top: 56.25%; /* 16:9 비율 유지 */ border-radius: 12px; overflow: hidden; background: #f7f4f0;">
      <video id="video" autoplay playsinline muted 
             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;"></video>
      <img id="detected" alt="실시간 감지 이미지" 
           style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 12px;" />
    </div>
  </div>
</div>

<script>
  const video = document.getElementById('video');
  const detected = document.getElementById('detected');

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { alert('카메라 접근 실패: ' + err); });

  async function sendFrame() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('frame', blob, 'frame.jpg');
        try {
          const res = await fetch('/detect/', { method: 'POST', body: formData });
          if (!res.ok) return;
          const imgBlob = await res.blob();
          detected.src = URL.createObjectURL(imgBlob);
        } catch {}
      }, 'image/jpeg');
    }
  }
  
  setInterval(sendFrame, 100);
</script>



    <!-- 선호도 선택 섹션 -->
    <section class="category" id="category-section" style="display:none;">
      <h4 class="category-title">음식 분야 선택</h4>
      <div class="chip-box">
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 한식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 일식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 양식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 중식</label>
        <label class="chip"><input type="checkbox" name="category" class="chip-radio" /> 기타</label>
      </div>
      <div class="range-wrap">
        <label>음식 간 선택</label>
        <input type="range" min="0" max="100" value="50" id="spicyRange" />
        <div class="range-labels">
          <span class="left-label">약하게</span>
          <span class="right-label">강하게</span>
        </div>
      </div>
      <div class="confirm-wrapper">
        <button class="confirm-btn" id="toRecipeBtn">선택 완료</button>
      </div>
    </section>

    <!-- 검색 결과 UI -->
    {% if query %}
    <section class="recommend" id="recipe-section" style="display:block;">
      {% if recipes %}
        <p>{{ query }}에 대한 추천 레시피 ({{ recipes|length }}개)</p>
        <div class="recipe-list" id="recipe-list">
          {% for recipe in recipes %}
          <div class="recipe-card" style="{% if forloop.counter > 3 %}display:none;{% endif %}">
            <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
            <h5>{{ recipe.title }}</h5>

            <h6 style="text-align: center;">재료</h6>
            <ul style="list-style-type: none; padding-left: 0;">
              {% for ing in recipe.ingredients %}
              <li>{{ ing.split.0 }}</li>
              {% endfor %}
            </ul>

            {% with "ingredients-"|add:recipe.id as script_id %}
              {{ recipe.ingredients|json_script:script_id }}
            {% endwith %}

            <a href="javascript:void(0)"
               class="btn-category-done show-extra-btn"
               data-recipe-id="{{ recipe.id }}">
               요리하러 가기
            </a>
          </div>
          {% endfor %}
        </div>

        {% if recipes|length > 3 %}
        <div style="text-align:center; margin-top:20px;">
          <button id="loadMoreBtn" class="confirm-btn">더보기</button>
        </div>
        {% endif %}
      {% else %}
        <p>‘{{ query }}’에 해당하는 레시피를 찾을 수 없습니다.</p>
      {% endif %}
    </section>
    {% endif %}

    <!-- 추가재료 선택 섹션 -->
    <section class="extra" id="extra-section" style="display:none;">
      <div class="extra-header">
        <h4 class="extra-title">추가 재료 선택</h4>
        <span class="small-text skip-extra" id="skip-extra-btn">
          추가 재료 없음 →
        </span>
      </div>

      <div class="chip-box" id="extra-ingredients"></div>

      <div class="cart-wrapper">
        <button class="cart-btns" id="go-cart-btn" style="margin-right: 10px;">장바구니로 이동</button>
        <button class="cart-btns" id="go-detail-btn">레시피 상세보기</button>
      </div>
    </section>
  </main>

  <div class="feedback-footer">
    © SmartCook. All rights reserved.
  </div>

  <!-- JS -->
  <script src="{% static 'js/upload.js' %}"></script>
</body>
</html>
